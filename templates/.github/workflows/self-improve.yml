name: Daily Self-Improvement

on:
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      hours:
        description: 'Time budget in hours'
        required: false
        default: '2'
        type: string
      focus:
        description: 'Focus area (optional)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (report only)'
        required: false
        default: false
        type: boolean

jobs:
  self-improve:
    runs-on: ubuntu-latest

    # Limit runtime to prevent runaway execution
    timeout-minutes: 150

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Run Claude Code Self-Improvement
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Run self-improvement command
          prompt: |
            /self-improve --hours ${{ inputs.hours || '2' }}${{ inputs.focus && format(' --focus "{0}"', inputs.focus) || '' }}${{ inputs.dry_run == 'true' && ' --dry-run' || '' }}

          # Optional: Customize Claude behavior
          # claude_args: '--allowed-tools Bash,Read,Write,Edit'

      - name: Check for PR creation
        id: check-pr
        if: always()
        run: |
          # Check if Claude created a PR
          if [ -f .self-improve-pr-number ]; then
            pr_number=$(cat .self-improve-pr-number)
            echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
            echo "âœ“ PR created: #$pr_number"
          fi

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: self-improve-report
          path: |
            self-improve-report.md
            improvements-skipped.md
            self-improve-errors.log
          retention-days: 30
          if-no-files-found: ignore

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read error log if exists
            let errors = 'No error log found. Check workflow logs for details.';
            if (fs.existsSync('self-improve-errors.log')) {
              errors = fs.readFileSync('self-improve-errors.log', 'utf8');
            }

            // Create issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Self-improvement failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Self-Improvement Failure\n\n**Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n**Workflow**: ${context.workflow}\n\n### Errors\n\n\`\`\`\n${errors}\n\`\`\`\n\n### Actions\n\n1. Review error log\n2. Fix underlying issue\n3. Re-run workflow\n\n---\nðŸ¤– Auto-created by self-improve workflow`,
              labels: ['self-improve-failure', 'bug', 'automated']
            });

      - name: Notify on success
        if: success() && steps.check-pr.outputs.pr_number != ''
        run: |
          echo "âœ“ Self-improvement completed successfully"
          echo "âœ“ PR created: #${{ steps.check-pr.outputs.pr_number }}"
          echo "âœ“ Review at: ${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.check-pr.outputs.pr_number }}"
